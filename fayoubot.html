   body {
        font-family: 'Vazirmatn', sans-serif;
        background-color: #f9f6f0;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .chat-container {
        max-height: 60vh;
        overflow-y: auto;
        scroll-behavior: smooth;
    }
    
    .chat-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
        background: var(--cream);
    }
    
    .chat-container::-webkit-scrollbar-thumb {
        background: var(--royal-green);
        border-radius: 10px;
    }
    
    .bot-message {
        background-color: var(--royal-green);
        color: white;
        border-radius: 15px 15px 15px 0;
    }
    
    .user-message {
        background-color: var(--cream);
        color: #333;
        border-radius: 15px 15px 0 15px;
        border: 1px solid #e2d9c2;
    }
    
    .option-btn {
        transition: all 0.3s ease;
    }
    
    .option-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(10, 92, 54, 0.2);
    }
    
    .gold-text {
        color: var(--gold);
    }
    
    .menu-item {
        transition: all 0.3s ease;
    }
    
    .menu-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(10, 92, 54, 0.2);
    }
    
    .loader {
        width: 48px;
        height: 24px;
        display: inline-block;
        position: relative;
        color: var(--royal-green);
    }
    
    .loader::after,
    .loader::before {
        content: '';  
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        position: absolute;
        animation: dot-move 2s linear infinite;
        top: 8px;
    }
    
    .loader::before {
        animation-delay: -1s;
    }
    
    @keyframes dot-move {
        0%, 100% { left: 0; }
        50% { left: 40px; }
    }
    
    .logo-container {
        position: relative;
    }
    
    .logo-text {
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
    }
    
    .logo-five {
        color: var(--royal-green);
    }
    
    .logo-lounge {
        color: var(--gold);
    }
    
    .custom-shadow {
        box-shadow: 0 10px 25px rgba(10, 92, 54, 0.15);
    }
    
    .menu-section {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease;
    }
    
    .menu-section.active {
        max-height: 1000px;
    }
    
    .menu-toggle {
        cursor: pointer;
    }
    
    .order-item {
        border-bottom: 1px dashed var(--gold);
        padding-bottom: 8px;
        margin-bottom: 8px;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
    <!-- Main Chat Interface -->
    <div class="bg-white rounded-2xl custom-shadow p-6">
        <!-- Chat Header -->
        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-700 to-green-500 flex items-center justify-center text-white text-xl font-bold">
                    AI
                </div>
                <div class="mr-3">
                    <h3 class="font-bold text-lg">دستیار هوشمند فایو لانژ</h3>
                    <p class="text-sm text-gray-500">همیشه در خدمت شما</p>
                </div>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                <span class="text-sm text-green-600">آنلاین</span>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-container" class="chat-container mb-6 p-2">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <!-- User Input -->
        <div id="user-input-container" class="flex items-center">
            <input id="user-input" type="text" placeholder="پیام خود را بنویسید..." class="flex-grow p-3 border border-gray-300 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <button id="send-button" class="bg-gradient-to-r from-green-700 to-green-600 text-white p-3 rounded-l-lg hover:from-green-800 hover:to-green-700 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
        
        <!-- Options Container -->
        <div id="options-container" class="mt-4 flex flex-wrap gap-2 justify-center">
            <!-- Options will be added here dynamically -->
        </div>
        
        <!-- Order Summary -->
        <div id="order-summary" class="mt-6 p-4 bg-green-50 rounded-lg border border-green-100 hidden">
            <h3 class="font-bold text-lg text-green-800 mb-3">خلاصه سفارش شما</h3>
            <div id="order-items" class="mb-4">
                <!-- Order items will be added here -->
            </div>
            <div class="flex justify-end">
                <button id="new-order-btn" class="bg-gradient-to-r from-green-700 to-green-600 text-white py-2 px-4 rounded-lg hover:from-green-800 hover:to-green-700 transition-all mr-2">
                    سفارش جدید
                </button>
                <button id="confirm-order-btn" class="bg-gradient-to-r from-amber-500 to-amber-400 text-white py-2 px-4 rounded-lg hover:from-amber-600 hover:to-amber-500 transition-all">
                    تأیید سفارش
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="text-center mt-6 text-sm text-gray-500">
        © فایو لانژ - تمامی حقوق محفوظ است
    </div>
</div>

<script>
    // State management
    const state = {
        currentStep: 'welcome',
        userName: '',
        phoneNumber: '',
        menuPath: '',
        answers: {},
        recommendations: {},
        currentOrder: [],
        conversationHistory: [],
        currentQuestionIndex: 0,
        hasOrderedHookah: false
    };
    
    // DOM Elements
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const optionsContainer = document.getElementById('options-container');
    const orderSummary = document.getElementById('order-summary');
    const orderItems = document.getElementById('order-items');
    const newOrderBtn = document.getElementById('new-order-btn');
    const confirmOrderBtn = document.getElementById('confirm-order-btn');
    
    // Menu data structure
    const menu = {
        appetizers: [
            "نان سیر", 
            "سوپ شف", 
            "دیپ بیکن", 
            "پاستیل مثلثی گل کلم", 
            "حمص", 
            "سیب زمینی سرخ شده با ادویه مخصوص"
        ],
        salads: [
            "سالاد سزار با مرغ گریل", 
            "سالاد فایو", 
            "سالاد استیک با درسینگ زرشک", 
            "سالاد باباغنوش", 
            "سالاد سزار با مرغ سوخاری"
        ],
        mainCourse: [
            "جوجه کشمیری", 
            "استیک مرغ گریل با نودل کدو سبز", 
            "استیک انتراکت", 
            "ماهی زعتر", 
            "شش کباب", 
            "بیف سولاکی", 
            "برنج کته زعفرانی", 
            "لقمه کباب کلاسیک ایرانی", 
            "شیرماهی کبابی"
        ],
        pizzas: [
            "الفردو و مرغ", 
            "پپرونی", 
            "سیر واستیک", 
            "سالامی", 
            "بیکن وخامه", 
            "مارگریتا"
        ],
        burgers: ["بلوچیزبرگر"],
        sandwiches: ["ساندویچ مرغ سوخاری"],
        pastas: [
            "پاستا اربیتا با استیک", 
            "الفردو مرغ", 
            "پستو"
        ],
        mocktails: [
            "پرشین موهیتو", 
            "بری موهیتو", 
            "ساموس", 
            "لیموناد زنجبیلی", 
            "موهیتو کوبایی", 
            "لیموناد کلاسیک", 
            "پشن کولا", 
            "رد ای کولا", 
            "چری کیس", 
            "کوکو کندی", 
            "بری کولادا"
        ],
        smoothies: [
            "تروپیکال فروت", 
            "وایلد بری"
        ],
        milkshakes: [
            "نوتلا", 
            "لوتوس", 
            "دبل چاکلت", 
            "تروپیکال", 
            "بری", 
            "کارامل نمکی"
        ],
        espressoBar: [
            "اسپرسو دبل", 
            "لاته", 
            "کاپوچینو", 
            "ماکیاتو طعم دار", 
            "امریکانو", 
            "افوگاتو"
        ],
        icedCoffee: [
            "اسپیشیال ایس کافی", 
            "ایس امریکانو", 
            "فراپاچینو", 
            "ایس لاته", 
            "ایس لاته طعم دار", 
            "ایس چالکت کافی", 
            "لمون ایس امریکانو"
        ],
        brewedCoffee: [
            "فرنچ پرس", 
            "قهوه شیخ", 
            "قهوه ترک"
        ],
        hotDrinks: [
            "چای سیاه کلاسیک", 
            "چای مراکشی", 
            "چای میوه ای جنگلی با چای ترش", 
            "هات چاکلت", 
            "دمنوش انرژی زا", 
            "دمنوش ارامش بخش", 
            "دمنوش سرما خوردگی", 
            "ماسالا چای"
        ],
        softDrinks: [
            "نوشیدنی های گازدار", 
            "اب معدنی"
        ],
        desserts: [
            "تیرامیسو پرسی", 
            "تیرامیسو ۶ نفره", 
            "هاویج با بستنی"
        ],
        hookahClassic: [
            "دوسیب", 
            "دوسیب البالو", 
            "انگور نعنا", 
            "آدامس دارچین", 
            "بلوبری", 
            "لیمو نعنا", 
            "پرتقال نعنا", 
            "شیر انبه", 
            "سیب یخ", 
            "هندوانه یخ", 
            "آلو یخ", 
            "پرتقال خامه"
        ],
        hookahPremium: [
            "امپراطوس(هلو-هندوانه-لیمو)", 
            "کویین(هلو-انبه-نعنا)", 
            "ادویه(میکس ادویه های عربی)", 
            "سنتورینی(رزبری-سیب سبز-آدامس)"
        ],
        hookahSpecial: ["قلیان ویژه فایو"]
    };
    
    // Questions for each menu path
    const questions = {
        restaurant: [
            "چه نوع غذایی را ترجیح می‌دهید؟ (گوشت قرمز، مرغ، ماهی، گیاهی)",
            "طعم‌های تند را دوست دارید یا ملایم؟",
            "آیا به دنبال غذای سبک هستید یا غذای سیرکننده؟",
            "آیا به دنبال غذای سنتی ایرانی هستید یا بین‌المللی؟",
            "آیا محدودیت غذایی خاصی دارید؟ (مثلاً گلوتن، لاکتوز و غیره)"
        ],
        cafe: [
            "نوشیدنی گرم ترجیح می‌دهید یا سرد؟",
            "طعم‌های شیرین را دوست دارید یا ترش؟",
            "آیا کافئین برای شما مهم است؟",
            "آیا به دنبال نوشیدنی سبک هستید یا غلیظ و پرمایه؟",
            "آیا طعم‌های میوه‌ای را ترجیح می‌دهید یا طعم‌های کلاسیک؟"
        ],
        hookah: [
            "طعم‌های میوه‌ای را ترجیح می‌دهید یا طعم‌های خاص؟",
            "طعم‌های شیرین را دوست دارید یا خنک و تازه؟",
            "آیا به دنبال تجربه‌ای معمولی هستید یا چیزی متفاوت و ویژه؟",
            "آیا ترکیب چند طعم را ترجیح می‌دهید یا یک طعم خالص؟",
            "آیا طعم‌های تند و قوی را دوست دارید یا ملایم و آرام؟"
        ]
    };
    
    // Initialize the chat
    function init() {
        addBotMessage("به فایو لانژ خوش آمدید! من دستیار هوشمند شما هستم و افتخار دارم که امروز در خدمت شما باشم. می‌توانم به شما در انتخاب بهترین غذاها و نوشیدنی‌های متناسب با سلیقه‌تان کمک کنم تا تجربه‌ای فراموش نشدنی داشته باشید.");
        setTimeout(() => {
            addBotMessage("لطفاً نام خود را وارد کنید تا بتوانم شما را بهتر راهنمایی کنم.");
            state.currentStep = 'getName';
        }, 1000);
        
        // Event listeners
        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
        
        newOrderBtn.addEventListener('click', startNewOrder);
        confirmOrderBtn.addEventListener('click', confirmOrder);
    }
    
    // Handle send button click
    function handleSend() {
        const message = userInput.value.trim();
        if (message === '') return;
        
        addUserMessage(message);
        userInput.value = '';
        
        // Process based on current step
        processUserInput(message);
    }
    
    // Process user input based on current step
    function processUserInput(message) {
        switch (state.currentStep) {
            case 'getName':
                // Extract name from message (first word or whole message if single word)
                const nameParts = message.split(' ');
                state.userName = nameParts[0].replace(/من|هستم|نام|است/g, '').trim();
                if (state.userName === '') state.userName = message.trim();
                
                addBotMessage(`خیلی خوشحالم از آشنایی با شما ${state.userName} عزیز! لطفاً شماره تماس خود را وارد کنید تا بتوانیم در آینده خدمات بهتری به شما ارائه دهیم.`);
                state.currentStep = 'getPhone';
                break;
                
            case 'getPhone':
                state.phoneNumber = message;
                addBotMessage(`ممنونم ${state.userName} عزیز! حالا بگویید از کدام بخش منوی ما می‌خواهید استفاده کنید؟`);
                showMenuOptions();
                state.currentStep = 'selectMenu';
                break;
                
            case 'selectMenu':
                handleMenuSelection(message);
                break;
                
            case 'answerQuestions':
                handleQuestionAnswer(message);
                break;
                
            case 'confirmRecommendation':
                handleRecommendationResponse(message);
                break;
                
            case 'askForDrink':
                handleDrinkResponse(message);
                break;
                
            case 'confirmDrink':
                handleDrinkConfirmation(message);
                break;
                
            case 'askForDessert':
                handleDessertResponse(message);
                break;
                
            case 'confirmDessert':
                handleDessertConfirmation(message);
                break;
                
            case 'askForHookah':
                handleHookahResponse(message);
                break;
                
            case 'confirmHookah':
                handleHookahConfirmation(message);
                break;
                
            case 'askForMore':
                handleMoreItemsResponse(message);
                break;
                
            case 'makeNewRecommendation':
                makeNewRecommendation(message);
                break;
                
            default:
                addBotMessage("متوجه نشدم. لطفاً دوباره تلاش کنید.");
        }
    }
    
    // Show menu selection options
    function showMenuOptions() {
        const options = [
            { text: "منوی رستوران", value: "restaurant" },
            { text: "منوی کافه", value: "cafe" },
            { text: "قلیان", value: "hookah" }
        ];
        
        showOptions(options);
    }
    
    // Handle menu selection
    function handleMenuSelection(message) {
        // Fix: Properly handle both button clicks and text input
        let menuPath = '';
        
        if (message === "restaurant" || message.includes("رستوران")) {
            menuPath = 'restaurant';
        } else if (message === "cafe" || message.includes("کافه")) {
            menuPath = 'cafe';
        } else if (message === "hookah" || message.includes("قلیان")) {
            menuPath = 'hookah';
            state.hasOrderedHookah = true;
        } else {
            addBotMessage("متوجه انتخاب شما نشدم. لطفاً یکی از گزینه‌های زیر را انتخاب کنید:");
            showMenuOptions();
            return;
        }
        
        state.menuPath = menuPath;
        state.currentQuestionIndex = 0;
        state.answers = {};
        
        addBotMessage(`عالیه! برای اینکه بتوانم بهترین پیشنهاد را به شما بدهم، لطفاً به چند سؤال کوتاه پاسخ دهید.`);
        setTimeout(() => {
            askNextQuestion();
        }, 1000);
        
        state.currentStep = 'answerQuestions';
    }
    
    // Ask the next question based on menu path
    function askNextQuestion() {
        const currentQuestions = questions[state.menuPath];
        
        if (state.currentQuestionIndex < currentQuestions.length) {
            const question = currentQuestions[state.currentQuestionIndex];
            addBotMessage(question);
            
            // Show some options based on the question
            if (state.currentQuestionIndex === 0) {
                if (state.menuPath === 'restaurant') {
                    showOptions([
                        { text: "گوشت قرمز", value: "گوشت قرمز" },
                        { text: "مرغ", value: "مرغ" },
                        { text: "ماهی", value: "ماهی" },
                        { text: "گیاهی", value: "گیاهی" }
                    ]);
                } else if (state.menuPath === 'cafe') {
                    showOptions([
                        { text: "گرم", value: "گرم" },
                        { text: "سرد", value: "سرد" }
                    ]);
                } else if (state.menuPath === 'hookah') {
                    showOptions([
                        { text: "میوه‌ای", value: "میوه‌ای" },
                        { text: "خاص", value: "خاص" }
                    ]);
                }
            } else if (state.currentQuestionIndex === 1) {
                if (state.menuPath === 'restaurant') {
                    showOptions([
                        { text: "تند", value: "تند" },
                        { text: "ملایم", value: "ملایم" }
                    ]);
                } else if (state.menuPath === 'cafe') {
                    showOptions([
                        { text: "شیرین", value: "شیرین" },
                        { text: "ترش", value: "ترش" }
                    ]);
                } else if (state.menuPath === 'hookah') {
                    showOptions([
                        { text: "شیرین", value: "شیرین" },
                        { text: "خنک و تازه", value: "خنک و تازه" }
                    ]);
                }
            } else if (state.currentQuestionIndex === 2) {
                if (state.menuPath === 'restaurant') {
                    showOptions([
                        { text: "سبک", value: "سبک" },
                        { text: "سیرکننده", value: "سیرکننده" }
                    ]);
                } else if (state.menuPath === 'cafe') {
                    showOptions([
                        { text: "بله، کافئین مهم است", value: "بله" },
                        { text: "خیر، کافئین مهم نیست", value: "خیر" }
                    ]);
                } else if (state.menuPath === 'hookah') {
                    showOptions([
                        { text: "معمولی", value: "معمولی" },
                        { text: "متفاوت و ویژه", value: "متفاوت و ویژه" }
                    ]);
                }
            }
        } else {
            // All questions answered, make recommendation
            makeRecommendation();
        }
    }
    
    // Handle question answers
    function handleQuestionAnswer(message) {
        const currentQuestions = questions[state.menuPath];
        state.answers[state.currentQuestionIndex] = message;
        state.currentQuestionIndex++;
        
        if (state.currentQuestionIndex < currentQuestions.length) {
            askNextQuestion();
        } else {
            makeRecommendation();
        }
    }
    
    // Make recommendation based on answers
    function makeRecommendation() {
        let recommendation = '';
        let reason = '';
        
        // Show thinking animation
        addThinkingAnimation();
        
        setTimeout(() => {
            removeThinkingAnimation();
            
            if (state.menuPath === 'restaurant') {
                const foodType = state.answers[0]?.toLowerCase() || '';
                const spicePreference = state.answers[1]?.toLowerCase() || '';
                const heaviness = state.answers[2]?.toLowerCase() || '';
                const cuisine = state.answers[3]?.toLowerCase() || '';
                
                if (foodType.includes('گوشت قرمز')) {
                    if (cuisine.includes('ایرانی') || cuisine.includes('سنتی')) {
                        recommendation = 'لقمه کباب کلاسیک ایرانی';
                        reason = 'با توجه به علاقه شما به گوشت قرمز و غذاهای سنتی ایرانی، لقمه کباب کلاسیک ایرانی ما که با بهترین گوشت و ادویه‌های مخصوص تهیه می‌شود، انتخاب مناسبی است.';
                    } else {
                        recommendation = 'استیک انتراکت';
                        reason = 'استیک انتراکت ما با گوشت مرغوب و پخت حرفه‌ای، برای علاقه‌مندان به گوشت قرمز و غذاهای بین‌المللی گزینه‌ای عالی است.';
                    }
                } else if (foodType.includes('مرغ')) {
                    if (spicePreference.includes('تند')) {
                        recommendation = 'جوجه کشمیری';
                        reason = 'جوجه کشمیری ما با ادویه‌های مخصوص و طعم تند و دلپذیر، برای شما که طعم‌های تند را دوست دارید، انتخابی عالی است.';
                    } else {
                        recommendation = 'شش کباب';
                        reason = 'شش کباب ما که با فیله مرغ تازه و مرینیت مدیترانه‌ای روی ذغال گریل می‌شود، طعمی ملایم و دلپذیر دارد که مناسب سلیقه شماست.';
                    }
                } else if (foodType.includes('ماهی')) {
                    recommendation = 'شیرماهی کبابی';
                    reason = 'شیرماهی کبابی ما که با بهترین ادویه‌ها طعم‌دار شده و به روشی خاص پخته می‌شود، برای علاقه‌مندان به غذاهای دریایی انتخابی بی‌نظیر است.';
                } else {
                    recommendation = 'سالاد فایو';
                    reason = 'سالاد فایو ما با ترکیبی از تازه‌ترین سبزیجات و سس مخصوص، گزینه‌ای سبک و مغذی برای شماست.';
                }
                
            } else if (state.menuPath === 'cafe') {
                const temperature = state.answers[0]?.toLowerCase() || '';
                const sweetness = state.answers[1]?.toLowerCase() || '';
                const caffeine = state.answers[2]?.toLowerCase() || '';
                const consistency = state.answers[3]?.toLowerCase() || '';
                const flavor = state.answers[4]?.toLowerCase() || '';
                
                if (temperature.includes('گرم')) {
                    if (caffeine.includes('مهم') || caffeine.includes('بله')) {
                        if (consistency.includes('غلیظ')) {
                            recommendation = 'لاته';
                            reason = 'لاته ما با اسپرسوی غلیظ و شیر مخملی، نوشیدنی گرم و پرکافئینی است که طعم غنی و دلپذیری دارد.';
                        } else {
                            recommendation = 'امریکانو';
                            reason = 'امریکانو با طعم قهوه خالص و رقیق‌تر، گزینه‌ای عالی برای کسانی است که نوشیدنی گرم با کافئین اما سبک‌تر می‌خواهند.';
                        }
                    } else {
                        if (flavor.includes('میوه')) {
                            recommendation = 'چای میوه ای جنگلی با چای ترش';
                            reason = 'چای میوه‌ای جنگلی ما با ترکیبی از میوه‌های خشک و چای ترش، نوشیدنی گرم و کم‌کافئینی است که طعم میوه‌ای دلپذیری دارد.';
                        } else {
                            recommendation = 'هات چاکلت';
                            reason = 'هات چاکلت ما با شکلات مرغوب و شیر تازه، نوشیدنی گرم و بدون کافئینی است که طعم شیرین و دلپذیری دارد.';
                        }
                    }
                } else {
                    if (sweetness.includes('شیرین')) {
                        if (flavor.includes('میوه')) {
                            recommendation = 'بری کولادا';
                            reason = 'بری کولادا با ترکیبی از توت‌های تازه و شیر نارگیل، نوشیدنی سرد و شیرینی است که طعم میوه‌ای دلپذیری دارد.';
                        } else {
                            recommendation = 'میلک شیک نوتلا';
                            reason = 'میلک شیک نوتلای ما با شکلات نوتلا و بستنی وانیلی، نوشیدنی سرد و شیرینی است که طعم غنی و دلپذیری دارد.';
                        }
                    } else {
                        recommendation = 'لیموناد زنجبیلی';
                        reason = 'لیموناد زنجبیلی ما با لیموی تازه و زنجبیل، نوشیدنی سرد و ترشی است که طعم تازه و نشاط‌آوری دارد.';
                    }
                }
                
            } else if (state.menuPath === 'hookah') {
                const flavorType = state.answers[0]?.toLowerCase() || '';
                const sweetness = state.answers[1]?.toLowerCase() || '';
                const experience = state.answers[2]?.toLowerCase() || '';
                const mixPreference = state.answers[3]?.toLowerCase() || '';
                const intensity = state.answers[4]?.toLowerCase() || '';
                
                if (experience.includes('ویژه') || experience.includes('متفاوت')) {
                    recommendation = 'قلیان ویژه فایو';
                    reason = 'قلیان ویژه فایو با ترکیب خاص و منحصر به فرد ما، تجربه‌ای متفاوت و فراموش‌نشدنی برای شما خواهد بود.';
                } else if (mixPreference.includes('ترکیب')) {
                    if (flavorType.includes('میوه')) {
                        recommendation = 'امپراطوس(هلو-هندوانه-لیمو)';
                        reason = 'قلیان امپراطوس با ترکیبی از طعم‌های هلو، هندوانه و لیمو، تجربه‌ای خنک و میوه‌ای را برای شما فراهم می‌کند.';
                    } else {
                        recommendation = 'سنتورینی(رزبری-سیب سبز-آدامس)';
                        reason = 'قلیان سنتورینی با ترکیبی از طعم‌های رزبری، سیب سبز و آدامس، تجربه‌ای خاص و متفاوت را برای شما فراهم می‌کند.';
                    }
                } else {
                    if (sweetness.includes('خنک')) {
                        recommendation = 'سیب یخ';
                        reason = 'قلیان سیب یخ با طعم سیب خنک و تازه، تجربه‌ای نشاط‌آور و دلپذیر را برای شما فراهم می‌کند.';
                    } else {
                        recommendation = 'بلوبری';
                        reason = 'قلیان بلوبری با طعم شیرین و دلپذیر توت آبی، انتخابی عالی برای کسانی است که طعم‌های شیرین را دوست دارند.';
                    }
                }
            }
            
            state.recommendations.main = recommendation;
            
            addBotMessage(`${state.userName} عزیز، با توجه به پاسخ‌های شما، پیشنهاد من برای شما "${recommendation}" است.`);
            addBotMessage(reason);
            addBotMessage("آیا این پیشنهاد مورد پسند شما است؟");
            
            showOptions([
                { text: "بله، عالیه", value: "yes" },
                { text: "خیر، پیشنهاد دیگری دارید؟", value: "no" }
            ]);
            
            state.currentStep = 'confirmRecommendation';
        }, 2000);
    }
    
    // Make a new recommendation based on feedback
    function makeNewRecommendation(message) {
        let recommendation = '';
        let reason = '';
        
        // Show thinking animation
        addThinkingAnimation();
        
        setTimeout(() => {
            removeThinkingAnimation();
            
            // Logic for alternative recommendations based on menu path
            if (state.menuPath === 'restaurant') {
                if (state.recommendations.main === 'استیک انتراکت') {
                    recommendation = 'بیف سولاکی';
                    reason = 'بیف سولاکی ما با گوشت مرینت شده و طعم منحصر به فرد، گزینه‌ای متفاوت برای علاقه‌مندان به گوشت قرمز است.';
                } else if (state.recommendations.main === 'شش کباب') {
                    recommendation = 'استیک مرغ گریل با نودل کدو سبز';
                    reason = 'استیک مرغ گریل ما با نودل کدو سبز، ترکیبی سبک و خوشمزه است که طعم متفاوتی نسبت به شش کباب دارد.';
                } else if (state.recommendations.main === 'شیرماهی کبابی') {
                    recommendation = 'ماهی زعتر';
                    reason = 'ماهی زعتر ما با ادویه‌های مدیترانه‌ای و طعم منحصر به فرد، گزینه‌ای متفاوت برای علاقه‌مندان به غذاهای دریایی است.';
                } else {
                    recommendation = 'سالاد سزار با مرغ گریل';
                    reason = 'سالاد سزار ما با مرغ گریل تازه و سس مخصوص، گزینه‌ای سبک و خوشمزه است که طعم متفاوتی نسبت به سالاد فایو دارد.';
                }
            } else if (state.menuPath === 'cafe') {
                if (state.recommendations.main.includes('لاته')) {
                    recommendation = 'کاپوچینو';
                    reason = 'کاپوچینوی ما با فوم مخملی و عطر دلپذیر، گزینه‌ای متفاوت برای علاقه‌مندان به نوشیدنی‌های گرم کافئین‌دار است.';
                } else if (state.recommendations.main.includes('چای')) {
                    recommendation = 'دمنوش ارامش بخش';
                    reason = 'دمنوش آرامش‌بخش ما با ترکیبی از گیاهان معطر، نوشیدنی گرم و بدون کافئینی است که حس آرامش خاصی به شما می‌دهد.';
                } else if (state.recommendations.main.includes('میلک شیک')) {
                    recommendation = 'اسموتی تروپیکال فروت';
                    reason = 'اسموتی تروپیکال فروت ما با ترکیبی از میوه‌های استوایی تازه، نوشیدنی سرد و مغذی است که طعم متفاوتی نسبت به میلک شیک دارد.';
                } else {
                    recommendation = 'موهیتو کوبایی';
                    reason = 'موهیتو کوبایی ما با نعناع تازه و لیمو، نوشیدنی سرد و نشاط‌آوری است که طعم متفاوتی نسبت به لیموناد دارد.';
                }
            } else if (state.menuPath === 'hookah') {
                if (state.recommendations.main.includes('ویژه')) {
                    recommendation = 'کویین(هلو-انبه-نعنا)';
                    reason = 'قلیان کویین با ترکیبی از طعم‌های هلو، انبه و نعنا، تجربه‌ای خاص و متفاوت را برای شما فراهم می‌کند.';
                } else if (state.recommendations.main.includes('امپراطوس')) {
                    recommendation = 'ادویه(میکس ادویه های عربی)';
                    reason = 'قلیان ادویه با ترکیبی از ادویه‌های عربی، تجربه‌ای کاملاً متفاوت و خاص را برای شما فراهم می‌کند.';
                } else {
                    recommendation = 'لیمو نعنا';
                    reason = 'قلیان لیمو نعنا با طعم خنک و تازه، تجربه‌ای نشاط‌آور و دلپذیر را برای شما فراهم می‌کند.';
                }
            }
            
            state.recommendations.main = recommendation;
            
            addBotMessage(`در این صورت، پیشنهاد جدید من برای شما "${recommendation}" است.`);
            addBotMessage(reason);
            addBotMessage("آیا این پیشنهاد مورد پسند شما است؟");
            
            showOptions([
                { text: "بله، عالیه", value: "yes" },
                { text: "خیر، پیشنهاد دیگری دارید؟", value: "no" }
            ]);
            
            state.currentStep = 'confirmRecommendation';
        }, 1500);
    }
    
    // Handle recommendation response
    function handleRecommendationResponse(message) {
        if (message.toLowerCase().includes('بله') || message.toLowerCase().includes('عالیه') || message.toLowerCase() === 'yes') {
            // Add to order
            addToOrder(state.recommendations.main);
            
            addBotMessage(`انتخاب بسیار خوبی! ${state.recommendations.main} به سفارش شما اضافه شد.`);
            
            if (state.menuPath === 'restaurant') {
                addBotMessage("آیا مایل هستید نوشیدنی هم سفارش دهید؟");
                
                showOptions([
                    { text: "بله", value: "yes" },
                    { text: "خیر", value: "no" }
                ]);
                
                state.currentStep = 'askForDrink';
            } else {
                // For cafe and hookah, skip dessert and go to more items or hookah question
                askForMoreOrHookah();
            }
        } else {
            addBotMessage("متوجه شدم. لطفاً بگویید چه نوع غذا یا نوشیدنی را ترجیح می‌دهید تا بتوانم پیشنهاد بهتری ارائه دهم.");
            state.currentStep = 'makeNewRecommendation';
            
            // Fix: Directly call makeNewRecommendation with the message
            makeNewRecommendation(message);
        }
    }
    
    // Handle drink response
    function handleDrinkResponse(message) {
        if (message.toLowerCase().includes('بله') || message.toLowerCase() === 'yes') {
            addBotMessage("عالیه! با توجه به انتخاب غذای شما، چه نوع نوشیدنی را ترجیح می‌دهید؟");
            
            showOptions([
                { text: "نوشیدنی گرم", value: "hot" },
                { text: "نوشیدنی سرد", value: "cold" },
                { text: "ماکتیل", value: "mocktail" }
            ]);
            
            state.currentStep = 'confirmDrink';
        } else {
            // If they don't want a drink, ask about dessert
            addBotMessage("آیا مایل هستید دسر هم سفارش دهید؟");
            
            showOptions([
                { text: "بله", value: "yes" },
                { text: "خیر", value: "no" }
            ]);
            
            state.currentStep = 'askForDessert';
        }
    }
    
    // Handle drink confirmation
    function handleDrinkConfirmation(message) {
        let drinkRecommendation = '';
        let reason = '';
        
        // Show thinking animation
        addThinkingAnimation();
        
        setTimeout(() => {
            removeThinkingAnimation();
            
            if (message.toLowerCase().includes('گرم') || message === 'hot') {
                if (state.recommendations.main.includes('کباب') || state.recommendations.main.includes('ایرانی')) {
                    drinkRecommendation = 'چای سیاه کلاسیک';
                    reason = 'چای سیاه کلاسیک ما، همراه سنتی و عالی برای غذاهای ایرانی است که طعم غذای شما را تکمیل می‌کند.';
                } else {
                    drinkRecommendation = 'امریکانو';
                    reason = 'امریکانو با طعم قهوه خالص و دلپذیر، همراه عالی برای غذای انتخابی شماست.';
                }
            } else if (message.toLowerCase().includes('سرد') || message === 'cold') {
                drinkRecommendation = 'لیموناد کلاسیک';
                reason = 'لیموناد کلاسیک ما با لیموی تازه و طعم خنک و گوارا، نوشیدنی مناسبی برای همراهی با غذای شماست.';
            } else if (message.toLowerCase().includes('ماکتیل') || message === 'mocktail') {
                drinkRecommendation = 'پرشین موهیتو';
                reason = 'پرشین موهیتو با ترکیبی از نعناع تازه، لیمو و زعفران، نوشیدنی خنک و خوش‌طعمی است که با غذای انتخابی شما هماهنگی عالی دارد.';
            } else {
                drinkRecommendation = 'لیموناد کلاسیک';
                reason = 'لیموناد کلاسیک ما با لیموی تازه و طعم خنک و گوارا، نوشیدنی مناسبی برای همراهی با غذای شماست.';
            }
            
            state.recommendations.drink = drinkRecommendation;
            
            addBotMessage(`پیشنهاد من برای نوشیدنی، "${drinkRecommendation}" است.`);
            addBotMessage(reason);
            addBotMessage("آیا این نوشیدنی را به سفارش خود اضافه می‌کنید؟");
            
            showOptions([
                { text: "بله، اضافه کن", value: "yes" },
                { text: "خیر، ممنون", value: "no" }
            ]);
            
            state.currentStep = 'askForDessert';
        }, 1500);
    }
    
    // Handle dessert response
    function handleDessertResponse(message) {
        if (message.toLowerCase().includes('بله') || message === 'yes') {
            // If they said yes to drink in previous step, add it to order
            if (state.currentStep === 'askForDessert' && state.recommendations.drink) {
                addToOrder(state.recommendations.drink);
                addBotMessage(`${state.recommendations.drink} به سفارش شما اضافه شد.`);
            }
            
            // Show thinking animation
            addThinkingAnimation();
            
            setTimeout(() => {
                removeThinkingAnimation();
                
                let dessertRecommendation = 'تیرامیسو پرسی';
                let reason = 'تیرامیسو پرسی ما با لایه‌های نرم و خوش‌طعم، دسر مناسبی برای پایان یک وعده غذایی لذت‌بخش است.';
                
                state.recommendations.dessert = dessertRecommendation;
                
                addBotMessage(`پیشنهاد من برای دسر، "${dessertRecommendation}" است.`);
                addBotMessage(reason);
                addBotMessage("آیا این دسر را به سفارش خود اضافه می‌کنید؟");
                
                showOptions([
                    { text: "بله، اضافه کن", value: "yes" },
                    { text: "خیر، ممنون", value: "no" }
                ]);
                
                state.currentStep = 'confirmDessert';
            }, 1500);
        } else {
            // If they said no to drink in previous step, skip adding drink
            if (state.currentStep === 'askForDessert' && state.recommendations.drink && message.toLowerCase() === 'no') {
                // Do nothing with the drink recommendation
            }
            
            // For restaurant path, ask about hookah if not already ordered
            if (state.menuPath === 'restaurant' && !state.hasOrderedHookah) {
                addBotMessage("آیا مایل هستید قلیان هم سفارش دهید؟");
                
                showOptions([
                    { text: "بله", value: "yes" },
                    { text: "خیر", value: "no" }
                ]);
                
                state.currentStep = 'askForHookah';
            } else {
                // Otherwise ask for more items
                askForMoreItems();
            }
        }
    }
    
    // Handle dessert confirmation
    function handleDessertConfirmation(message) {
        if (message.toLowerCase().includes('بله') || message === 'yes') {
            addToOrder(state.recommendations.dessert);
            addBotMessage(`${state.recommendations.dessert} به سفارش شما اضافه شد.`);
        }
        
        // For restaurant path, ask about hookah if not already ordered
        if (state.menuPath === 'restaurant' && !state.hasOrderedHookah) {
            addBotMessage("آیا مایل هستید قلیان هم سفارش دهید؟");
            
            showOptions([
                { text: "بله", value: "yes" },
                { text: "خیر", value: "no" }
            ]);
            
            state.currentStep = 'askForHookah';
        } else {
            // Otherwise ask for more items
            askForMoreItems();
        }
    }
    
    // Handle hookah response
    function handleHookahResponse(message) {
        if (message.toLowerCase().includes('بله') || message === 'yes') {
            // Save current menu path to return to it later
            const previousMenuPath = state.menuPath;
            
            // Switch to hookah path
            state.menuPath = 'hookah';
            state.currentQuestionIndex = 0;
            state.answers = {};
            state.hasOrderedHookah = true;
            
            addBotMessage("عالیه! برای پیشنهاد بهترین قلیان، لطفاً به چند سؤال کوتاه پاسخ دهید.");
            setTimeout(() => {
                askNextQuestion();
            }, 1000);
            
            state.currentStep = 'answerQuestions';
        } else {
            // If they don't want hookah, ask for more items
            askForMoreItems();
        }
    }
    
    // Handle hookah confirmation
    function handleHookahConfirmation(message) {
        if (message.toLowerCase().includes('بله') || message === 'yes') {
            addToOrder(state.recommendations.hookah);
            addBotMessage(`${state.recommendations.hookah} به سفارش شما اضافه شد.`);
        }
        
        askForMoreItems();
    }
    
    // Ask for more items or hookah based on menu path
    function askForMoreOrHookah() {
        if (state.menuPath === 'restaurant' && !state.hasOrderedHookah) {
            addBotMessage("آیا مایل هستید قلیان هم سفارش دهید؟");
            
            showOptions([
                { text: "بله", value: "yes" },
                { text: "خیر", value: "no" }
            ]);
            
            state.currentStep = 'askForHookah';
        } else {
            askForMoreItems();
        }
    }
    
    // Ask if user wants more items
    function askForMoreItems() {
        addBotMessage("آیا مایل هستید چیز دیگری به سفارش خود اضافه کنید؟");
        
        showOptions([
            { text: "بله", value: "yes" },
            { text: "خیر، سفارشم را نهایی کن", value: "no" }
        ]);
        
        state.currentStep = 'askForMore';
    }
    
    // Handle more items response
    function handleMoreItemsResponse(message) {
        if (message.toLowerCase().includes('بله') || message === 'yes') {
            addBotMessage(`${state.userName} عزیز، از کدام بخش منوی ما می‌خواهید استفاده کنید؟`);
            showMenuOptions();
            state.currentStep = 'selectMenu';
        } else {
            // Finalize order
            showOrderSummary();
            
            addBotMessage(`${state.userName} عزیز، از انتخاب شما متشکرم! سفارش شما ثبت شد و به زودی آماده خواهد شد.`);
            addBotMessage("امیدوارم از انتخاب‌های خود لذت ببرید و تجربه خوشایندی در فایو لانژ داشته باشید.");
            
            state.currentStep = 'orderComplete';
        }
    }
    
    // Add to order
    function addToOrder(item) {
        state.currentOrder.push(item);
    }
    
    // Show order summary
    function showOrderSummary() {
        orderSummary.classList.remove('hidden');
        orderItems.innerHTML = '';
        
        state.currentOrder.forEach((item, index) => {
            const orderItem = document.createElement('div');
            orderItem.className = 'order-item';
            orderItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium">${index + 1}. ${item}</span>
                </div>
            `;
            orderItems.appendChild(orderItem);
        });
    }
    
    // Start new order
    function startNewOrder() {
        state.currentOrder = [];
        orderSummary.classList.add('hidden');
        state.hasOrderedHookah = false;
        
        addBotMessage(`${state.userName} عزیز، خوشحالم که دوباره می‌توانم به شما کمک کنم. از کدام بخش منوی ما می‌خواهید استفاده کنید؟`);
        showMenuOptions();
        state.currentStep = 'selectMenu';
    }
    
    // Confirm order
    function confirmOrder() {
        addBotMessage("سفارش شما با موفقیت ثبت شد. از انتخاب فایو لانژ متشکریم و امیدواریم تجربه خوشایندی داشته باشید.");
        orderSummary.classList.add('hidden');
    }
    
    // Add bot message to chat
    function addBotMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'bot-message p-3 mb-3 max-w-3/4 fade-in';
        messageElement.textContent = message;
        chatContainer.appendChild(messageElement);
        scrollToBottom();
    }
    
    // Add user message to chat
    function addUserMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'user-message p-3 mb-3 mr-auto max-w-3/4 fade-in';
        messageElement.textContent = message;
        chatContainer.appendChild(messageElement);
        scrollToBottom();
    }
    
    // Show options as buttons
    function showOptions(options) {
        optionsContainer.innerHTML = '';
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option-btn bg-gradient-to-r from-green-700 to-green-600 text-white py-2 px-4 rounded-lg hover:from-green-800 hover:to-green-700 transition-all m-1';
            button.textContent = option.text;
            button.addEventListener('click', () => {
                addUserMessage(option.text);
                processUserInput(option.value);
                optionsContainer.innerHTML = '';
            });
            optionsContainer.appendChild(button);
        });
    }
    
    // Add thinking animation
    function addThinkingAnimation() {
        const thinkingElement = document.createElement('div');
        thinkingElement.id = 'thinking-animation';
        thinkingElement.className = 'bot-message p-3 mb-3 max-w-3/4';
        thinkingElement.innerHTML = '<span class="loader"></span>';
        chatContainer.appendChild(thinkingElement);
        scrollToBottom();
    }
    
    // Remove thinking animation
    function removeThinkingAnimation() {
        const thinkingElement = document.getElementById('thinking-animation');
        if (thinkingElement) {
            thinkingElement.remove();
        }
    }
    
    // Scroll to bottom of chat
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Initialize the chat
    init();
</script>
